import time,json,requests
import pyodbc
import urllib.parse
"""
url = "http://supportcenter.in.t-internal.com/helpdesk/WebObjects/Helpdesk.woa/ra/Tickets?qualifier=((clientId %3D " + "172" + "))&apiKey=VTEXGXaHe0fvMK1wS0kie7U1e4umXMNv5UM1a1UK"
resp = requests.get(url)
time.sleep(1.5)
if resp.status_code != 200:
    print('Error: Rest API Error with Status Code: ' + str(resp.status_code))
else:
    obj = json.loads(resp.content)

ticket_present = False;
my_entity = "1078";
print(obj[0]['id'])
for x in obj:
    print(x['id'])
    if(str(x['id']) == str(my_entity)):
        ticket_present = True
        break

if ticket_present == False:
    print("The ticket number is invalid. Showing your latest ticket.")
    print("ticket_number",obj[0]['id'])
"""
user_name = "A90431271"
first_name = "amol"
last_name = "sangar"
email = "amol.sangar@t-systems.com"
#email = urllib.parse.quote(email)
print (email)
conversation_details = """{"sender_id":"A90431271","slots":{"account_type":null,"client_id":172,"company_name":"T-Systems ICT India Pvt. Ltd.","dept_id":15,"dept_name":"ServiceNowSSC-Viraj Awati-47200013","email_id":"amol.sangar@t-systems.com","first_name":"Amol","generated_ticket_number":null,"last_name":"Sangar","loc_id":1,"loc_name":"PUNE-SHIVAJI NAGAR","requested_slot":null,"solved":null,"subject":"reset wiw password","ticket_number":"0","user_name":"A90431271"},"latest_message":{"text":"\/confirmation.no","intent":{"name":"confirmation.no","confidence":1.0},"intent_ranking":[{"name":"confirmation.no","confidence":1.0}],"entities":[]},"latest_event_time":1566152779.5900001526,"followup_action":null,"paused":false,"events":[{"event":"slot","timestamp":1566151259.5230000019,"name":"email_id","value":"amol.sangar@t-systems.com"},{"event":"slot","timestamp":1566151259.5230000019,"name":"client_id","value":172},{"event":"slot","timestamp":1566151259.5230000019,"name":"company_name","value":"T-Systems ICT India Pvt. Ltd."},{"event":"slot","timestamp":1566151259.5230000019,"name":"dept_id","value":15},{"event":"slot","timestamp":1566151259.5230000019,"name":"dept_name","value":"ServiceNowSSC-Viraj Awati-47200013"},{"event":"slot","timestamp":1566151259.5230000019,"name":"loc_id","value":1},{"event":"slot","timestamp":1566151259.5230000019,"name":"loc_name","value":"PUNE-SHIVAJI NAGAR"},{"event":"slot","timestamp":1566151259.5230000019,"name":"first_name","value":"Amol"},{"event":"slot","timestamp":1566151259.5230000019,"name":"last_name","value":"Sangar"},{"event":"slot","timestamp":1566151259.5230000019,"name":"user_name","value":"A90431271"},{"event":"action","timestamp":1566151259.5429999828,"name":"action_listen","policy":null,"confidence":1.0},{"event":"user","timestamp":1566151566.1610000134,"text":"hi","parse_data":{"intent":{"name":"greetings.hello","confidence":0.9728079438},"entities":[],"intent_ranking":[{"name":"greetings.hello","confidence":0.9728079438},{"name":"thanks","confidence":0.0279714912},{"name":"abuse","confidence":0.0242096111},{"name":"greetings.bye","confidence":0.0199730732},{"name":"stop","confidence":0.0151548069},{"name":"ticket_details","confidence":0.003012713},{"name":"inform","confidence":0.0},{"name":"password_reset","confidence":0.0},{"name":"confirmation.no","confidence":0.0},{"name":"confirmation.yes","confidence":0.0}],"text":"hi"},"input_channel":"rest"},{"event":"action","timestamp":1566151566.1990001202,"name":"utter_greetings.hello","policy":"policy_4_KerasPolicy","confidence":0.9655364752},{"event":"bot","timestamp":1566151566.1990001202,"text":"Hi Amol! How can I help you?","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566151566.2350001335,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.9968095422},{"event":"user","timestamp":1566151567.632999897,"text":"hello","parse_data":{"intent":{"name":"greetings.hello","confidence":0.9540926218},"entities":[],"intent_ranking":[{"name":"greetings.hello","confidence":0.9540926218},{"name":"ticket_details","confidence":0.1195344776},{"name":"stop","confidence":0.095882833},{"name":"greetings.bye","confidence":0.0391592085},{"name":"thanks","confidence":0.0115292892},{"name":"abuse","confidence":0.0},{"name":"inform","confidence":0.0},{"name":"confirmation.no","confidence":0.0},{"name":"password_reset","confidence":0.0},{"name":"confirmation.yes","confidence":0.0}],"text":"hello"},"input_channel":"rest"},{"event":"action","timestamp":1566151567.6610000134,"name":"utter_greetings.hello","policy":"policy_4_KerasPolicy","confidence":0.9941798449},{"event":"bot","timestamp":1566151567.6610000134,"text":"Greetings Amol! What's troubling you today?","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566151567.6870000362,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.9986550808},{"event":"user","timestamp":1566151570.5420000553,"text":"yo","parse_data":{"intent":{"name":"greetings.hello","confidence":0.8283974528},"entities":[],"intent_ranking":[{"name":"greetings.hello","confidence":0.8283974528},{"name":"greetings.bye","confidence":0.4398120046},{"name":"stop","confidence":0.1536009759},{"name":"inform","confidence":0.0},{"name":"thanks","confidence":0.0},{"name":"confirmation.yes","confidence":0.0},{"name":"abuse","confidence":0.0},{"name":"inform_ticket_number","confidence":0.0},{"name":"ticket_details","confidence":0.0},{"name":"confirmation.no","confidence":0.0}],"text":"yo"},"input_channel":"rest"},{"event":"action","timestamp":1566151570.5710000992,"name":"utter_greetings.hello","policy":"policy_4_KerasPolicy","confidence":0.9944346547},{"event":"bot","timestamp":1566151570.5710000992,"text":"Hi there, Amol! What can I do for you today?","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566151570.5989999771,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.9986960292},{"event":"user","timestamp":1566151578.0910000801,"text":"bye","parse_data":{"intent":{"name":"greetings.bye","confidence":0.9694203138},"entities":[],"intent_ranking":[{"name":"greetings.bye","confidence":0.9694203138},{"name":"stop","confidence":0.1230112463},{"name":"greetings.hello","confidence":0.0044780225},{"name":"abuse","confidence":0.0},{"name":"inform","confidence":0.0},{"name":"inform_ticket_number","confidence":0.0},{"name":"email.id","confidence":0.0},{"name":"thanks","confidence":0.0},{"name":"ticket_details","confidence":0.0},{"name":"confirmation.yes","confidence":0.0}],"text":"bye"},"input_channel":"rest"},{"event":"action","timestamp":1566151578.1319999695,"name":"utter_greetings.bye","policy":"policy_4_KerasPolicy","confidence":0.994595468},{"event":"bot","timestamp":1566151578.1319999695,"text":"Till next time!","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566151578.1719999313,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.9991133809},{"event":"user","timestamp":1566151579.2129998207,"text":"bye","parse_data":{"intent":{"name":"greetings.bye","confidence":0.9694203138},"entities":[],"intent_ranking":[{"name":"greetings.bye","confidence":0.9694203138},{"name":"stop","confidence":0.1230112463},{"name":"greetings.hello","confidence":0.0044780225},{"name":"abuse","confidence":0.0},{"name":"inform","confidence":0.0},{"name":"inform_ticket_number","confidence":0.0},{"name":"email.id","confidence":0.0},{"name":"thanks","confidence":0.0},{"name":"ticket_details","confidence":0.0},{"name":"confirmation.yes","confidence":0.0}],"text":"bye"},"input_channel":"rest"},{"event":"action","timestamp":1566151579.2510001659,"name":"utter_greetings.bye","policy":"policy_4_KerasPolicy","confidence":0.9962790608},{"event":"bot","timestamp":1566151579.2510001659,"text":"Till next time!","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566151579.2940001488,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.9990459085},{"event":"user","timestamp":1566151582.9100000858,"text":"reset emea2 password please","parse_data":{"intent":{"name":"password_reset","confidence":0.9812496901},"entities":[{"start":6,"end":11,"value":"emea2","entity":"account_type","confidence":0.9615062226,"extractor":"CRFEntityExtractor","processors":["EntitySynonymMapper"]}],"intent_ranking":[{"name":"password_reset","confidence":0.9812496901},{"name":"ticket_details","confidence":0.0528066009},{"name":"greetings.hello","confidence":0.0344960019},{"name":"abuse","confidence":0.0087024122},{"name":"email.id","confidence":0.0},{"name":"inform_ticket_number","confidence":0.0},{"name":"thanks","confidence":0.0},{"name":"inform","confidence":0.0},{"name":"confirmation.yes","confidence":0.0},{"name":"greetings.bye","confidence":0.0}],"text":"reset emea2 password please"},"input_channel":"rest"},{"event":"action","timestamp":1566151584.1240000725,"name":"password_reset_form","policy":"policy_4_KerasPolicy","confidence":0.9926428199},{"event":"bot","timestamp":1566151584.1240000725,"text":"We found the following solution to your problem. Have a look at it.","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"form","timestamp":1566151584.1240000725,"name":"password_reset_form"},{"event":"slot","timestamp":1566151584.1240000725,"name":"account_type","value":"emea2"},{"event":"slot","timestamp":1566151584.1240000725,"name":"account_type","value":null},{"event":"slot","timestamp":1566151584.1240000725,"name":"subject","value":"reset emea2 password please"},{"event":"form","timestamp":1566151584.1240000725,"name":null},{"event":"slot","timestamp":1566151584.1240000725,"name":"requested_slot","value":null},{"event":"action","timestamp":1566151584.2160000801,"name":"utter_is_problem_solved","policy":"policy_4_KerasPolicy","confidence":0.9491426349},{"event":"bot","timestamp":1566151584.2160000801,"text":"Did that solve your problem?","data":{"elements":null,"quick_replies":null,"buttons":[{"payload":"\/confirmation.yes","title":"Yes"},{"payload":"\/confirmation.no","title":"No"}],"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566151584.2870001793,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.9964840412},{"event":"user","timestamp":1566151606.0910000801,"text":"\/confirmation.no","parse_data":{"text":"\/confirmation.no","intent":{"name":"confirmation.no","confidence":1.0},"intent_ranking":[{"name":"confirmation.no","confidence":1.0}],"entities":[]},"input_channel":"rest"},{"event":"action","timestamp":1566151606.135999918,"name":"utter_raise_ticket","policy":"policy_4_KerasPolicy","confidence":0.9565637708},{"event":"bot","timestamp":1566151606.135999918,"text":"Ohh!! That's bad! Please create a ticket here: \n <a href='http:\/\/supportcenter.in.t-internal.com\/' target='_blank'>IT Support<\/a>","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566151609.6040000916,"name":"action_db_operation","policy":"policy_4_KerasPolicy","confidence":0.9484279156},{"event":"action","timestamp":1566151609.6600000858,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.9964932799},{"event":"user","timestamp":1566152773.3580000401,"text":"reset wiw password","parse_data":{"intent":{"name":"password_reset","confidence":0.9811806679},"entities":[{"start":6,"end":9,"value":"wiw","entity":"account_type","confidence":0.9680277533,"extractor":"CRFEntityExtractor"}],"intent_ranking":[{"name":"password_reset","confidence":0.9811806679},{"name":"ticket_details","confidence":0.0475305803},{"name":"abuse","confidence":0.0198125876},{"name":"greetings.hello","confidence":0.0009919461},{"name":"email.id","confidence":0.0},{"name":"inform","confidence":0.0},{"name":"inform_ticket_number","confidence":0.0},{"name":"confirmation.no","confidence":0.0},{"name":"thanks","confidence":0.0},{"name":"greetings.bye","confidence":0.0}],"text":"reset wiw password"},"input_channel":"rest"},{"event":"action","timestamp":1566152774.4930000305,"name":"password_reset_form","policy":"policy_4_KerasPolicy","confidence":0.9887498617},{"event":"bot","timestamp":1566152774.4930000305,"text":"We found the following solution to your problem. Have a look at it.","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"form","timestamp":1566152774.4930000305,"name":"password_reset_form"},{"event":"slot","timestamp":1566152774.4930000305,"name":"account_type","value":"wiw"},{"event":"slot","timestamp":1566152774.4930000305,"name":"account_type","value":null},{"event":"slot","timestamp":1566152774.4930000305,"name":"subject","value":"reset wiw password"},{"event":"form","timestamp":1566152774.4930000305,"name":null},{"event":"slot","timestamp":1566152774.4930000305,"name":"requested_slot","value":null},{"event":"action","timestamp":1566152774.5209999084,"name":"utter_is_problem_solved","policy":"policy_4_KerasPolicy","confidence":0.9541482329},{"event":"bot","timestamp":1566152774.5209999084,"text":"Did that solve your problem?","data":{"elements":null,"quick_replies":null,"buttons":[{"payload":"\/confirmation.yes","title":"Yes"},{"payload":"\/confirmation.no","title":"No"}],"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566152774.5439999104,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.996443212},{"event":"user","timestamp":1566152776.2499997616,"text":"\/confirmation.no","parse_data":{"text":"\/confirmation.no","intent":{"name":"confirmation.no","confidence":1.0},"intent_ranking":[{"name":"confirmation.no","confidence":1.0}],"entities":[]},"input_channel":"rest"},{"event":"action","timestamp":1566152776.2990000248,"name":"utter_raise_ticket","policy":"policy_4_KerasPolicy","confidence":0.9560819864},{"event":"bot","timestamp":1566152776.2990000248,"text":"Ohh!! That's bad! Please create a ticket here: \n <a href='http:\/\/supportcenter.in.t-internal.com\/' target='_blank'>IT Support<\/a>","data":{"elements":null,"quick_replies":null,"buttons":null,"attachment":null,"image":null,"custom":null},"metadata":{}},{"event":"action","timestamp":1566152779.5209999084,"name":"action_db_operation","policy":"policy_4_KerasPolicy","confidence":0.9484279156},{"event":"action","timestamp":1566152779.5900001526,"name":"action_listen","policy":"policy_4_KerasPolicy","confidence":0.9964932799}],"latest_input_channel":"rest","active_form":{},"latest_action_name":"action_listen"} """
generated_ticket_number = ""
solved = "YES"
solved = solved.upper()
intent =  "Password reset"

conn = pyodbc.connect('Driver={SQL Server};'
                            'Server=10.197.194.145;'
                            'Database=T-BOT;'
                            'uid=sa;'
                            'pwd=Pass-w0rd;'
                            )

cursor = conn.cursor()

#c2 = json.loads(conversation_details)
#print(repr(c2))
#c3 = json.dumps(c2)
#print(c3)

str = conversation_details.replace("'", "''")
print(str)
exit()

sql_insert_query_1 = "EXEC [T-BOT].[dbo].[conv_insert] @a_id='{}',@first_name='{}',@last_name='{}',@email='{}',@conv_details='{}',@ticket_no='{}',@intent='{}',@is_solved='{}'".format(user_name, first_name, last_name, email, c3, generated_ticket_number, intent, solved)

print(sql_insert_query_1)
cursor.execute(sql_insert_query_1)
conn.commit()

#for row in cursor:
    #print(row)

cursor.close()